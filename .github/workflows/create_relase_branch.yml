name: Create Release Branch

on:
  workflow_dispatch:
    inputs:
      release_version:
        description: 'Release version (format: vMAJOR.MINOR or vMAJOR.MINOR.PATCH, e.g., v1.0 or v1.0.0)'
        required: true

jobs:
  create_release_branch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Git
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"

      - name: Validate Version Format
        run: |
          VERSION_PATTERN='^v[0-9]+\.[0-9]+(\.[0-9]+)?$'
          if [[ ! "${{ github.event.inputs.release_version }}" =~ $VERSION_PATTERN ]]; then
            echo "Error: Release version '${{ github.event.inputs.release_version }}' does not match the required format 'vMAJOR.MINOR' or 'vMAJOR.MINOR.PATCH'."
            exit 1
          fi

      - name: Create Release Branch
        run: |
          RELEASE_BRANCH="release-${{ github.event.inputs.release_version }}"

          # Fetch all branches from origin
          git fetch origin

          # Ensure the 'develop' branch is available locally
          git checkout -b develop origin/develop

          # Check if any release branch already exists
          if git ls-remote --heads origin 'release-*' | grep 'refs/heads/release-'; then
            echo "Error: An existing release branch was found. Only one release branch is allowed at a time."
            echo "Please finish or close the existing release branch before creating a new one."
            exit 1
          else
            echo "No existing release branches found. Proceeding..."
          fi

          # Create the release branch from develop
          git checkout -b $RELEASE_BRANCH develop

          # Push the new release branch to the remote repository
          git push origin $RELEASE_BRANCH

          echo "Release branch '$RELEASE_BRANCH' created from 'develop' and pushed to origin."
